{
  "id": "snapshot_1766996276101_ysoxqz44i",
  "approvalId": "approval_1766996276088_txo62806z",
  "approvalTitle": "entity-save-and-actions requirements",
  "version": 1,
  "timestamp": "2025-12-29T08:17:56.101Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document\n\n## Introduction\nYAML 定義から生成されたフォームの保存処理とカスタムアクション実行を実装し、HTMX 部分更新で結果/エラーを返せるようにする。これにより現在 501 のプレースホルダを解消し、モデル駆動 CRUD を完成形に近づける。\n\n## Alignment with Product Vision\n- Declarative-first: 保存・アクションも YAML 定義とサービス層に集約し、UI 側は共通テンプレートで扱う。\n- Server-driven UI: HTMX で部分テンプレートを返し、フルリロードせずにフォーム結果やエラーを表示する。\n- Extensible hooks: form.actions からカスタムアクションを差し込み、ハンドラ登録で拡張可能にする。\n- Secure/Observable: 入力を検証し、詳細なエラーはログに残しつつ UI には簡潔なメッセージを返す。\n\n## Requirements\n\n### Requirement 1: フォーム保存とバリデーション応答\n\n**User Story:** 開発者として、生成されたフォームを送信するとサーバ側でバリデーションと保存が行われ、成功時は詳細ビューが更新され、失敗時はフィールド別エラーを部分テンプレートで受け取りたい。\n\n#### Acceptance Criteria\n1. WHEN POST /<entity>/save is called with valid payload THEN the system SHALL persist the record via repository.save and return a 200 HTMX partial that re-renders the detail or list pane.\n2. IF validation fails (missing required field or type mismatch) THEN the system SHALL return a 400 partial that includes field-level error messages without full-page reload.\n3. IF the entity is unknown OR the record to update is not found THEN the system SHALL return 404 with a concise message and log the details server-side.\n4. WHEN save succeeds THEN the response SHALL include updated primary key value and reflect in the UI (e.g., buttons/link targets use the new/existing pk).\n\n### Requirement 2: カスタムアクションディスパッチ\n\n**User Story:** 開発者として、YAML の form.actions/list.actions で定義したボタンからカスタムアクションを呼び出し、登録済みハンドラが実行されて結果を HTMX で受け取りたい。\n\n#### Acceptance Criteria\n1. WHEN POST /<entity>/actions/<action> is called AND the action exists AND a handler is registered THEN the system SHALL execute it and return 200 partial content (message or fragment) to the target.\n2. IF the action is defined in YAML but no handler is registered THEN the system SHALL return 501 with a user-friendly notice and log the absence.\n3. IF the action name is not defined for the entity THEN the system SHALL return 404 with a concise error body and log it.\n4. WHEN handler raises an exception THEN the system SHALL catch it, log it with entity/action context, and return 500 partial with a safe error message.\n\n### Requirement 3: YAML エラーの UI 露出\n\n**User Story:** 管理者として、entities.yaml の定義ミスがある場合は早期に UI 上で検知し、どのエンティティに問題があるかを把握したい。\n\n#### Acceptance Criteria\n1. WHEN entities.yaml fails validation at startup THEN the system SHALL log detailed errors and expose a minimal banner/message in the main layout or root view indicating configuration errors.\n2. WHEN an entity config is missing or invalid at request time THEN the system SHALL return 500/404 partial with an error snippet instead of an unhandled exception.\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n- Service 層で保存・アクションロジックをまとめ、リポジトリ層はデータ操作に限定する。\n- テンプレートは部分更新を前提に共通化し、エラー表示もコンポーネント化する。\n\n### Performance\n- 保存・アクションの HTMX 応答 P95 < 500ms を目標とし、ペイロードは対象部分テンプレートのみに限定する。\n\n### Security\n- フォーム入力はサーバ側で検証し、SQL はパラメータバインドを使用する。\n- エラー詳細はログに残し、UI には簡潔なメッセージのみ返す。\n\n### Reliability\n- 例外は握り、HTTP ステータスと部分テンプレートで応答する。\n- バリデーション/保存/アクション処理の単体・統合テストを追加し回帰を防ぐ。\n\n### Usability\n- フィールド単位のエラー表示と、成功時のリダイレクトなし部分更新を提供する。\n- 成功/失敗メッセージは DaisyUI コンポーネントで視認性を確保する。\n",
  "fileStats": {
    "size": 4642,
    "lines": 62,
    "lastModified": "2025-12-29T08:17:53.044Z"
  },
  "comments": []
}