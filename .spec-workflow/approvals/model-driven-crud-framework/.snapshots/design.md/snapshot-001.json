{
  "id": "snapshot_1766898935223_9pm0mjhqi",
  "approvalId": "approval_1766898935218_wouw4dg4y",
  "approvalTitle": "model-driven-crud-framework design (JP)",
  "version": 1,
  "timestamp": "2025-12-28T05:15:35.223Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\nYAML 定義 (`config/entities.yaml`) を基点に、一覧・詳細・フォーム UI を自動生成するモデル駆動 CRUD フレームワークを Databricks Apps 上で提供する。Flask + HTMX によりサーバー駆動で部分更新を行い、Tailwind + DaisyUI で一貫した見た目を保つ。Alpine.js はモーダル等の局所状態のみで利用する。\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- サーバー駆動 UI (Flask + HTMX) を採用し、フロントの状態は最小化する。\n- YAML 定義が唯一の UI ソース。SQLAlchemy 予定だが現状は `db.py` の DBAPI プールを活用しつつ、リポジトリ層で差し替え可能に設計。\n- Secrets/環境変数で接続設定を注入し、バリデーションとログ出力を標準化する。\n\n### Project Structure (structure.md)\n- 依存方向: UI → Service → Repository → DB。`approot/templates` に共通コンポーネント、`approot/services`/`approot/repositories` にロジックを配置。\n- `db.py` をリポジトリ層から呼び出す形に整理し、将来の SQLAlchemy 置き換えに備える。\n\n## Code Reuse Analysis\n- 既存再利用: `approot/app.py` の Flask 初期化とルーティング枠組み、`approot/db.py` のコネクションプール、`approot/templates/partials/list.html`・`detail.html` のパターンを汎用化のたたき台として利用。\n- 統合ポイント: `config/entities.yaml` を正規化して読み込むローダーを新設し、サービス層でエンティティ定義を引き回す。\n\n### Existing Components to Leverage\n- **db.py**: Databricks SQL 用プール取得・接続。リポジトリ層から利用。\n- **app.py**: ルート定義のベース。汎用エンドポイント追加で拡張。\n- **templates/partials/list.html, detail.html**: 既存の一覧・詳細テンプレート構造を汎用コンポーネントへ展開。\n\n### Integration Points\n- **Database**: 既存 customers テーブルをサンプルデータソースとして利用しつつ、汎用化後は YAML の `table` を参照して任意テーブルをクエリ。\n- **HTMX**: 一覧/詳細/フォーム/lookup の各部分テンプレートを hx-target で返却。\n\n## Architecture\n- YAML ローダーでエンティティ定義を読み込み、スキーマ検証後にサービス層へ提供。\n- サービス層: 汎用 CRUD 処理 (list/detail/save) とカスタムアクションのディスパッチを担当。\n- リポジトリ層: テーブル名とカラムを基にクエリを組み立て、`db.py` 経由で実行。将来 SQLAlchemy に差し替え可。\n- UI: Jinja2 テンプレートで汎用グリッド・フォーム・lookup コンポーネントを組み立て、HTMX で部分更新。\n\n```mermaid\nflowchart LR\n    YAML[config/entities.yaml] --> Loader[Entities Loader + Validation]\n    Loader --> Service[Generic Entity Service]\n    Service --> Repo[Generic Repository]\n    Repo --> DB[(Databricks SQL)]\n    Service --> Templates[HTMX Partials (grid/form/detail/lookup)]\n    Templates --> Browser[HTMX + Alpine]\n```\n\n### Modular Design Principles\n- Single Responsibility: ローダー/サービス/リポジトリ/テンプレートを分離。\n- Component Isolation: グリッド・フォーム・フィールド・lookup を部分テンプレート化。\n- Service Layer Separation: Flask ルートはサービス経由でリポジトリを呼ぶ。\n- Utility Modularity: YAML 検証と正規化をユーティリティ関数に分割。\n\n## Components and Interfaces\n\n### Entities Loader (`approot/services/entities_loader.py` 想定)\n- **Purpose:** YAML を読み込み、スキーマ検証し、辞書形式の定義を返す。\n- **Interfaces:** `load_entities(path: str) -> dict[str, EntityConfig]`、`get_entity(name) -> EntityConfig`。\n- **Dependencies:** `yaml`、スキーマ定義 (pydantic/手書き検証)。\n- **Reuses:** `config/entities.yaml`。\n\n### Generic Repository (`approot/repositories/generic_repo.py`)\n- **Purpose:** テーブル名・カラム定義に基づく list/detail/lookup クエリを実行。\n- **Interfaces:** `fetch_list(entity, page, page_size, sort)`、`fetch_detail(entity, pk)`、`search_lookup(entity, q, limit)`、`save(entity, payload)`（初期は読み取り中心）。\n- **Dependencies:** `db.py` のコネクション取得。\n- **Reuses:** 既存 `db.py`。\n\n### Generic Service (`approot/services/generic_service.py`)\n- **Purpose:** エンティティ定義を解釈し、テンプレート描画に必要なデータとコンテキストを組み立てる。\n- **Interfaces:** `render_list(entity, query_params)`、`render_detail(entity, pk)`、`render_form(entity, pk|None)`、`handle_action(entity, action_name, form_data)`。\n- **Dependencies:** Entities Loader、Generic Repository、テンプレートレンダリング。\n- **Reuses:** shared templates。\n\n### Flask Routes (`approot/app.py` 拡張)\n- **Purpose:** 汎用エンドポイントを束ね、HTMX 部分テンプレートを返す。\n- **Interfaces:**\n  - `GET /<entity>/list` (htmx partial)\n  - `GET /<entity>/detail/<id>` (htmx partial)\n  - `GET /<entity>/form[/<id>]` (htmx partial)\n  - `POST /<entity>/save` (htmx partial response)\n  - `GET /lookup/<lookup_name>` (lookup modal 内検索)\n  - `POST /<entity>/actions/<action>` (カスタムアクション)\n- **Dependencies:** Generic Service。\n\n### Templates\n- **components/datagrid.html**: グリッド本体。ソート/ページングを hx-get で処理。\n- **components/form.html + field_types/**: フィールドレンダリングを型ごとに分割。\n- **components/lookup.html**: Lookup モーダルと検索結果描画。\n- **partials/list.html / detail.html / form.html**: エンティティ単位の HTMX レスポンス。\n\n## Data Models\n\n### EntityConfig (YAML 正規化後)\n- `name: str`\n- `table: str`\n- `label: str`\n- `primary_key: str` (デフォルト `id` など)\n- `list: ListConfig`\n- `form: FormConfig`\n\n### ListConfig\n- `columns: list[ColumnConfig]` (name, label, width, sortable)\n- `default_sort: str | None`\n- `page_size: int`\n- `actions: list[ActionConfig]`\n\n### FormConfig\n- `sections: list[FormSection]`\n- `actions: list[ActionConfig]`\n\n### FormSection\n- `label: str`\n- `fields: list[FieldConfig]`\n\n### FieldConfig\n- `name: str`\n- `label: str`\n- `type: str` (text/textarea/email/lookup 等)\n- `lookup: str | None` (lookup 用)\n- `rows: int | None`\n- `display: str | None` (lookup 表示列)\n\n### ActionConfig\n- `name: str`\n- `label: str`\n- `endpoint: str` (Flask ルートまたはカスタム実装先)\n\n## Error Handling\n\n### YAML 検証エラー\n- **Handling:** 読み込み時にバリデーションし、どのエンティティ/パスが不正かをログに出力。UI には「定義が不正」のメッセージを返す。\n- **User Impact:** 管理者向けエラー表示（簡潔）、詳細はログ。\n\n### DB アクセスエラー\n- **Handling:** リポジトリで例外を捕捉しログ、HTMX レスポンスで簡潔な失敗メッセージを返す。\n- **User Impact:** 画面内に失敗通知を表示。再試行案内。\n\n### カスタムアクション実行エラー\n- **Handling:** サービスで例外を握り、部分テンプレートでエラーを返す。入力検証を徹底。\n- **User Impact:** アクション結果領域にエラー表示。\n\n## Testing Strategy\n\n### Unit Testing\n- エンティティローダーの YAML 検証・正規化テスト。\n- リポジトリのクエリ組み立てロジック（ソート/ページング/lookup）をモック DB で検証。\n- サービスのコンテキスト組み立て（list/form/detail のデータ形状）。\n\n### Integration Testing\n- Flask テストクライアントで HTMX エンドポイントを叩き、部分テンプレート内の主要要素（列ヘッダ、フィールド、ボタン生成、エラー表示）を検証。\n- Lookup エンドポイントの検索結果と選択動作（hidden 値更新の HTML）を確認。\n\n### End-to-End Testing\n- 簡易なブラウザレス E2E（htmx リクエスト連鎖）で一覧→詳細→フォーム送信のフローを確認。\n- 主要エンティティ（例: customer）で P95 応答 < 500ms を計測し、リグレッション検出のベースラインを作成。\n",
  "fileStats": {
    "size": 8416,
    "lines": 154,
    "lastModified": "2025-12-28T05:15:32.529Z"
  },
  "comments": []
}