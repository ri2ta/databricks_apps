# 要件ドキュメント

## はじめに
Databricks Apps 上で、YAML によるエンティティ定義だけで CRUD UI を自動生成するモデル駆動フレームワークを提供する。Flask + HTMX + Tailwind + DaisyUI + Alpine.js を用い、開発者が業務ロジック実装に専念できる状態をつくる。

## プロダクトビジョンとの整合
- Declarative-first: UI は YAML 定義を唯一の真実とし、ロジックは Flask 層へ分離。
- Server-driven UI: HTMX による部分更新で軽量な UX を維持。
- Extensible hooks: YAML からカスタムアクションやフィールド型を追加可能にする。
- Secure/Observable: 入力バリデーションとログ/メトリクスを標準化し、Apps 運用に適合。

## 機能要件

### 要件1: YAML 主導の CRUD 自動生成

**ユーザーストーリー:** 内製開発者として、config/entities.yaml にエンティティを書くと一覧・詳細・フォーム画面が自動生成され、UI コードを重複して書かずに済ませたい。

#### 受け入れ条件
1. config/entities.yaml にエンティティブロックを追加すると、共有テンプレートを用いて list/detail/form の各画面が追加の UI コーディングなしに描画されること。
2. YAML の list.columns が指定するラベル・順序・幅がグリッドに反映されること。
3. YAML の form.sections/fields が指定するフィールド種別・ラベル・グルーピングが DaisyUI/Tailwind のスタイルで描画されること。
4. 必須の YAML 属性が欠落または不正な場合、エンティティ名と不正箇所を含むバリデーションエラーを返すこと。

### 要件2: HTMX ベースの汎用データグリッド

**ユーザーストーリー:** ビジネスユーザーとして、ページングとソートに対応したインタラクティブな一覧でレコードを効率的に閲覧したい。

#### 受け入れ条件
1. GET /<entity>/list が呼ばれたとき、現在の行データとページネーションを含むグリッド部分テンプレートを HTMX で返すこと。
2. カラムヘッダのソート操作に応じ、ページング文脈を維持したままソート結果で再描画されること。
3. 行クリックで該当レコードの詳細部分テンプレートを指定の hx-target に表示すること。
4. データ件数が複数ページにまたがる場合、前後ページの取得を HTMX で行い、フルリロードしないこと。

### 要件3: 汎用フォームとカスタムアクション差し込み

**ユーザーストーリー:** 開発者として、YAML 定義からフォームを生成しつつカスタムアクションを差し込めるようにし、ドメイン固有の処理を UI を作り直さずに追加したい。

#### 受け入れ条件
1. フォーム表示時、YAML のフィールド型定義（text/textarea/email/lookup など）に従い共有フィールドテンプレートで描画されること。
2. フォーム送信を HTMX で行った際、成功/バリデーションエラーを含む部分レスポンスをメイン領域へ返すこと。
3. YAML の form.actions に定義された endpoint を持つボタンが生成され、現在のフォームデータを POST できること。
4. バリデーション失敗時、ページ全体を置き換えずにフィールド別のエラーメッセージを返すこと。

### 要件4: Lookup コンポーネントによる参照選択

**ユーザーストーリー:** 利用者として、モーダル検索で関連レコードを選び、ID を手入力せずにエンティティを関連付けたい。

#### 受け入れ条件
1. Lookup トリガー操作でモーダルオーバーレイが開き、検索入力が Lookup 用 HTMX エンドポイントに接続されること。
2. 検索結果を選択すると hidden 値が選択 ID に更新され、表示テキストがリロードなしで更新されること。
3. Lookup エンドポイントが結果を返さない場合、モーダル内に空状態メッセージを表示すること。

### 要件5: フォーム保存とバリデーション応答

**ユーザーストーリー:** 開発者として、生成されたフォームを送信するとサーバ側でバリデーションと保存が行われ、成功時は詳細ビューが更新され、失敗時はフィールド別エラーを部分テンプレートで受け取りたい。

#### 受け入れ条件
1. `POST /<entity>/save` に妥当なペイロードを送ると、repository.save 経由で永続化し、詳細または一覧の HTMX 部分テンプレートを 200 で返すこと。
2. 必須欠落や型不一致などバリデーション失敗時は、400 の部分テンプレートでフィールド単位のエラーメッセージを返し、フルリロードしないこと。
3. 不明なエンティティまたは更新対象レコードが無い場合は、404 と簡潔なメッセージを返し、詳細をサーバ側にログすること。
4. 保存成功時は、主キー値を含めて UI のリンク/ボタンが新規・既存の pk を正しく反映すること。

### 要件6: カスタムアクションディスパッチ

**ユーザーストーリー:** 開発者として、YAML の `form.actions` / `list.actions` で定義したボタンからカスタムアクションを呼び出し、登録済みハンドラが実行されて結果を HTMX で受け取りたい。

#### 受け入れ条件
1. `POST /<entity>/actions/<action>` に対し、アクションが定義されハンドラが登録済みなら、ハンドラを実行し 200 の部分コンテンツ（メッセージやフラグメント）を返すこと。
2. YAML に定義はあるがハンドラ未登録の場合は、501 とユーザーフレンドリーな案内を返し、不在をログすること。
3. エンティティに定義されていないアクション名の場合は、404 と簡潔なエラーボディを返し、サーバ側に記録すること。
4. ハンドラ内で例外が発生した場合は握り、エンティティ/アクション名を含めてログし、500 の安全なエラーメッセージを部分テンプレートで返すこと。

### 要件7: YAML エラーの UI 露出

**ユーザーストーリー:** 管理者として、`entities.yaml` の定義ミスがある場合は早期に UI 上で検知し、どのエンティティに問題があるかを把握したい。

#### 受け入れ条件
1. `entities.yaml` のバリデーションが起動時に失敗した場合、詳細をログしつつ、メインレイアウトやルートビューに簡潔なバナー/メッセージで設定エラーを示すこと。
2. リクエスト時にエンティティ定義が欠落または不正な場合、未処理例外にせず 500/404 の部分テンプレートでエラースニペットを返すこと。

### 要件8: SQLAlchemy ベースの汎用 DB 層

**ユーザーストーリー:** 開発者として、既存のサービスインターフェースや機能を変えずに DB 層を SQLAlchemy ベースへ置き換え、エンティティ横断で再利用できる汎用化された永続化を使いたい。

#### 受け入れ条件
1. Repository/db 層が SQLAlchemy（Core/ORM いずれか）で実装され、`generic_service` など既存サービスの公開インターフェース・応答仕様は変更しないこと。
2. DB 接続設定は環境変数/Secret Scope 経由で外部化し、SQLAlchemy の接続プール管理を用いて接続リークが無いこと。
3. CRUD/Lookup/アクション向けの DB 操作は SQLAlchemy のパラメータ化されたクエリ/ステートメントで実装され、エンティティ定義のメタデータを使って汎用的に組み立てられること。
4. 置き換え後も既存のテスト（一覧/詳細/保存/アクション/Lookup）がグリーンとなり、サービス層の戻り値やバリデーション挙動が変わらないこと。

## 非機能要件

### アーキテクチャ/モジュール性
- レイヤは UI → Service → Repository → DB。共有テンプレート/コンポーネントは templates/components・templates/partials に集約。
- DB アクセスは db.py もしくはリポジトリ層に集約し、サービス層に明確なインターフェースを提供する。
- HTMX 部分テンプレートとフィールド部分テンプレートを再利用し、重複を避ける。

### パフォーマンス
- Databricks Apps 想定負荷下で HTMX 応答（list/form/detail/save/actions）の P95 < 500ms。
- ページング・ソートはフルリロードを避け、ペイロードを最小化する。

### セキュリティ
- Secrets をコードに埋め込まない（Secret Scope/環境変数経由）。
- YAML 入力とフォーム送信を検証し、危険な値は拒否またはサニタイズする。フォーム保存とアクション入力はサーバ側で型・必須性を検証し、SQL はパラメータバインドを徹底する。
- 利用者には最小限のエラー情報のみ返し、詳細はサーバーログに記録する。

### 信頼性
- 欠落/空のエンティティ定義を検知し、ユーザーフレンドリーなメッセージとサーバーログを出す。
- DB コネクションプール初期化の失敗をログに残し、フォールバックメッセージで利用者に知らせる。
- 保存・アクション・バリデーション処理は例外を握り、HTTP ステータスと部分テンプレートで返す。

### ユーザビリティ
- グリッド/フォーム/Lookup で Tailwind + DaisyUI の一貫したスタイルを保つ。
- HTMX で部分更新後もフォーカスやスクロール位置を可能な限り維持する。
- インラインのバリデーションエラーと成功メッセージを部分テンプレートで返す。
- バナー/スニペットで YAML 構成エラーを伝達し、フォーム保存結果を視認性の高いコンポーネントで表示する。
