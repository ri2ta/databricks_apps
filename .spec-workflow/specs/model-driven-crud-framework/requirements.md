# 要件ドキュメント

## はじめに
Databricks Apps 上で、YAML によるエンティティ定義だけで CRUD UI を自動生成するモデル駆動フレームワークを提供する。Flask + HTMX + Tailwind + DaisyUI + Alpine.js を用い、開発者が業務ロジック実装に専念できる状態をつくる。

## プロダクトビジョンとの整合
- Declarative-first: UI は YAML 定義を唯一の真実とし、ロジックは Flask 層へ分離。
- Server-driven UI: HTMX による部分更新で軽量な UX を維持。
- Extensible hooks: YAML からカスタムアクションやフィールド型を追加可能にする。
- Secure/Observable: 入力バリデーションとログ/メトリクスを標準化し、Apps 運用に適合。

## 機能要件

### 要件1: YAML 主導の CRUD 自動生成

**ユーザーストーリー:** 内製開発者として、config/entities.yaml にエンティティを書くと一覧・詳細・フォーム画面が自動生成され、UI コードを重複して書かずに済ませたい。

#### 受け入れ条件
1. config/entities.yaml にエンティティブロックを追加すると、共有テンプレートを用いて list/detail/form の各画面が追加の UI コーディングなしに描画されること。
2. YAML の list.columns が指定するラベル・順序・幅がグリッドに反映されること。
3. YAML の form.sections/fields が指定するフィールド種別・ラベル・グルーピングが DaisyUI/Tailwind のスタイルで描画されること。
4. 必須の YAML 属性が欠落または不正な場合、エンティティ名と不正箇所を含むバリデーションエラーを返すこと。

### 要件2: HTMX ベースの汎用データグリッド

**ユーザーストーリー:** ビジネスユーザーとして、ページングとソートに対応したインタラクティブな一覧でレコードを効率的に閲覧したい。

#### 受け入れ条件
1. GET /<entity>/list が呼ばれたとき、現在の行データとページネーションを含むグリッド部分テンプレートを HTMX で返すこと。
2. カラムヘッダのソート操作に応じ、ページング文脈を維持したままソート結果で再描画されること。
3. 行クリックで該当レコードの詳細部分テンプレートを指定の hx-target に表示すること。
4. データ件数が複数ページにまたがる場合、前後ページの取得を HTMX で行い、フルリロードしないこと。

### 要件3: 汎用フォームとカスタムアクション差し込み

**ユーザーストーリー:** 開発者として、YAML 定義からフォームを生成しつつカスタムアクションを差し込めるようにし、ドメイン固有の処理を UI を作り直さずに追加したい。

#### 受け入れ条件
1. フォーム表示時、YAML のフィールド型定義（text/textarea/email/lookup など）に従い共有フィールドテンプレートで描画されること。
2. フォーム送信を HTMX で行った際、成功/バリデーションエラーを含む部分レスポンスをメイン領域へ返すこと。
3. YAML の form.actions に定義された endpoint を持つボタンが生成され、現在のフォームデータを POST できること。
4. バリデーション失敗時、ページ全体を置き換えずにフィールド別のエラーメッセージを返すこと。

### 要件4: Lookup コンポーネントによる参照選択

**ユーザーストーリー:** 利用者として、モーダル検索で関連レコードを選び、ID を手入力せずにエンティティを関連付けたい。

#### 受け入れ条件
1. Lookup トリガー操作でモーダルオーバーレイが開き、検索入力が Lookup 用 HTMX エンドポイントに接続されること。
2. 検索結果を選択すると hidden 値が選択 ID に更新され、表示テキストがリロードなしで更新されること。
3. Lookup エンドポイントが結果を返さない場合、モーダル内に空状態メッセージを表示すること。

## 非機能要件

### アーキテクチャ/モジュール性
- レイヤは UI → Service → Repository → DB。共有テンプレート/コンポーネントは templates/components・templates/partials に集約。
- DB アクセスは db.py もしくはリポジトリ層に集約し、サービス層に明確なインターフェースを提供する。
- HTMX 部分テンプレートとフィールド部分テンプレートを再利用し、重複を避ける。

### パフォーマンス
- Databricks Apps 想定負荷下で HTMX 応答（list/form/detail）の P95 < 500ms。
- ページング・ソートはフルリロードを避け、ペイロードを最小化する。

### セキュリティ
- Secrets をコードに埋め込まない（Secret Scope/環境変数経由）。
- YAML 入力とフォーム送信を検証し、危険な値は拒否またはサニタイズする。
- 利用者には最小限のエラー情報のみ返し、詳細はサーバーログに記録する。

### 信頼性
- 欠落/空のエンティティ定義を検知し、ユーザーフレンドリーなメッセージとサーバーログを出す。
- DB コネクションプール初期化の失敗をログに残し、フォールバックメッセージで利用者に知らせる。

### ユーザビリティ
- グリッド/フォーム/Lookup で Tailwind + DaisyUI の一貫したスタイルを保つ。
- HTMX で部分更新後もフォーカスやスクロール位置を可能な限り維持する。
- インラインのバリデーションエラーと成功メッセージを部分テンプレートで返す。
