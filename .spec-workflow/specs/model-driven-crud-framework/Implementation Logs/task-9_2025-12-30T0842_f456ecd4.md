# Implementation Log: Task 9

**Summary:** YAML 検証失敗をレイアウトで通知するバナーとHTMX向けエラーパーツを追加し、未定義エンティティ応答を統一した上でテストを補強しました。

**Timestamp:** 2025-12-30T08:42:54.063Z
**Log ID:** f456ecd4-47c0-4438-9cc8-eadf52de6e35

---

## Statistics

- **Lines Added:** +210
- **Lines Removed:** -11
- **Files Changed:** 7
- **Net Change:** 199

## Files Modified
- .spec-workflow/specs/model-driven-crud-framework/tasks.md
- approot/app.py
- approot/templates/layout.html
- tests/test_app_routes.py
- tests/test_save_endpoint.py

## Files Created
- approot/templates/partials/error.html
- tests/test_entity_load_error.py

---

## Artifacts

### API Endpoints

#### GET /<entity_name>/list
- **Purpose:** Return entity list partial; unknown entity now returns HTMX-friendly error partial with DaisyUI alert
- **Location:** approot/app.py:63-81
- **Request Format:** Query params: page (int, default 1), page_size (int, optional), sort (str, optional)
- **Response Format:** Success: HTML partial list; Errors: render partials/error.html with title/message and status codes 404/500

#### GET /<entity_name>/detail/<pk>
- **Purpose:** Return entity detail partial; unknown entity/record returns HTMX-friendly error partial
- **Location:** approot/app.py:84-99
- **Request Format:** Path: pk (int)
- **Response Format:** Success: partials/entity.html; 404 uses partials/error.html with friendly message; other errors use same partial with status

#### GET /<entity_name>/form[/<pk>]
- **Purpose:** Render create/edit form partial; missing entity/record renders HTMX-friendly error partial
- **Location:** approot/app.py:101-116
- **Request Format:** Path: pk optional int
- **Response Format:** Success: partials/entity.html; 404 partials/error.html with title/message; other errors similar

#### POST /<entity_name>/save
- **Purpose:** Validate and persist entity record; unknown entity/record returns error partial instead of plain text
- **Location:** approot/app.py:119-144
- **Request Format:** Form fields for entity schema
- **Response Format:** Success 200 partials/entity.html; 400 form partial with errors; 404/500 partials/error.html with title/message

#### GET /
- **Purpose:** Render layout and show YAML validation banner when entity load failed at startup
- **Location:** approot/app.py:49-52
- **Request Format:** None
- **Response Format:** layout.html with optional alert banner driven by entity_load_error flag

### Components

#### ErrorAlertPartial
- **Type:** Jinja
- **Purpose:** Reusable HTMX error partial using DaisyUI alert styling for error responses
- **Location:** approot/templates/partials/error.html
- **Props:** title (optional), message (optional)
- **Exports:** default

#### LayoutYamlErrorBanner
- **Type:** Jinja layout
- **Purpose:** Displays a warning banner when entities.yaml validation fails at startup
- **Location:** approot/templates/layout.html
- **Props:** entity_load_error boolean
- **Exports:** layout block content

### Integrations

#### Integration
- **Description:** Startup entity load sets _ENTITY_LOAD_ERROR flag and passes it into layout to surface YAML validation issues to the user
- **Frontend Component:** layout.html
- **Backend Endpoint:** GET / (index)
- **Data Flow:** App import -> entities_loader result -> flag stored -> index route renders layout with banner when flag true

#### Integration
- **Description:** Generic entity routes reuse partials/error.html for 404/500 responses so HTMX calls render consistent DaisyUI alerts instead of plain text
- **Frontend Component:** HTMX partial consumers
- **Backend Endpoint:** /<entity>/list|detail|form|save
- **Data Flow:** Service returns ctx with ok False -> app routes render partials/error.html -> HTMX swaps alert into target container

