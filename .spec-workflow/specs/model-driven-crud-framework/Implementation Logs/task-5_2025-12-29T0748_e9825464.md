# Implementation Log: Task 5

**Summary:** Flaskに汎用エンティティルートを追加し、HTMX部分テンプレートを返すCRUDエンドポイントをTDDで実装。既存ルートを維持しつつテスト21本を追加。

**Timestamp:** 2025-12-29T07:48:47.851Z
**Log ID:** e9825464-aba6-405d-848e-ba66c3875958

---

## Statistics

- **Lines Added:** +676
- **Lines Removed:** -0
- **Files Changed:** 6
- **Net Change:** 676

## Files Modified
- approot/app.py
- .spec-workflow/specs/model-driven-crud-framework/tasks.md
- tests/test_app_routes.py
- .spec-workflow/specs/model-driven-crud-framework/Implementation Logs/task-5_2025-12-29T0650_5d9f4e84.md

## Files Created
- tests/test_app_routes.py
- .spec-workflow/specs/model-driven-crud-framework/Implementation Logs/task-5_2025-12-29T0650_5d9f4e84.md

---

## Artifacts

### API Endpoints

#### GET /<entity_name>/list
- **Purpose:** エンティティ一覧をページング・ソート付きで返し、partials/list.html を描画
- **Location:** approot/app.py#L42-L66
- **Request Format:** query params: page (int, default 1), page_size (int, optional), sort (str, optional)
- **Response Format:** HTML partial list; on error plain text with status

#### GET /<entity_name>/detail/<int:pk>
- **Purpose:** エンティティ詳細を view モードで返し、partials/entity.html を描画
- **Location:** approot/app.py#L69-L86
- **Request Format:** path: entity_name, pk
- **Response Format:** HTML partial entity; error text on failure

#### GET /<entity_name>/form
- **Purpose:** 新規作成用フォーム (mode=create) を描画
- **Location:** approot/app.py#L89-L107
- **Request Format:** path: entity_name
- **Response Format:** HTML partial entity form

#### GET /<entity_name>/form/<int:pk>
- **Purpose:** 編集用フォーム (mode=edit) を描画
- **Location:** approot/app.py#L89-L107
- **Request Format:** path: entity_name, pk
- **Response Format:** HTML partial entity form; 404 if not found

#### POST /<entity_name>/save
- **Purpose:** エンティティ保存エンドポイント（現状プレースホルダーで501を返却）
- **Location:** approot/app.py#L110-L125
- **Request Format:** form data posted from entity form
- **Response Format:** "Save operation not yet implemented" with 501; 404 for unknown entity

#### POST /<entity_name>/actions/<action_name>
- **Purpose:** カスタムアクションを generic_service に委譲し結果を返す
- **Location:** approot/app.py#L128-L146
- **Request Format:** path: entity_name, action_name; form payload mapped to dict
- **Response Format:** text message 200 on success; error text with status from ctx

#### GET /lookup/<lookup_name>
- **Purpose:** lookup用検索結果を返し、components/lookup.html を描画
- **Location:** approot/app.py#L149-L180
- **Request Format:** query params: q (str), limit (int, default 20), field_name (str)
- **Response Format:** HTML modal partial with results; 500 on exception

### Functions

#### stub_requests_and_env
- **Purpose:** Databricks/requests依存をスタブしテストをクリーンに実行
- **Location:** tests/test_app_routes.py#L8-L34
- **Signature:** (monkeypatch) -> None
- **Exported:** No

#### mock_load_entities
- **Purpose:** entities_loader.load_entities をテスト用エンティティ返却に置き換え
- **Location:** tests/test_app_routes.py#L52-L68
- **Signature:** (path: str) -> ValidationResult
- **Exported:** No

#### mock_fetch_list
- **Purpose:** generic_repo.fetch_list を固定データでスタブ
- **Location:** tests/test_app_routes.py#L82-L92
- **Signature:** (entity, page=1, page_size=None, sort=None) -> list
- **Exported:** No

#### mock_fetch_detail
- **Purpose:** generic_repo.fetch_detail を固定データでスタブ
- **Location:** tests/test_app_routes.py#L94-L99
- **Signature:** (entity, pk) -> dict|None
- **Exported:** No

### Integrations

#### Integration
- **Description:** Flask汎用ルートが generic_service を呼び、Jinja部分テンプレート（list/entity/lookup）を HTMX ターゲットへ返す
- **Frontend Component:** HTMX partials (partials/list.html, partials/entity.html, components/lookup.html)
- **Backend Endpoint:** GET/POST /<entity>/* and /lookup/*
- **Data Flow:** Client HTMX request -> Flask generic route -> generic_service/generic_repo -> render_template partial -> HTMX swaps into #main-pane or modal

