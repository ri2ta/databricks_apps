# Implementation Log: Task 7

**Summary:** 汎用保存パイプラインを実装し、POST /<entity>/save の成功・バリデーション・404・500 をカバーする TDD を追加。フォームのフィールド別エラー表示とレガシー /list 互換を維持しつつ、新しい保存ロジックをリポジトリ/サービスに実装した。

**Timestamp:** 2025-12-30T05:06:24.612Z
**Log ID:** 31248b52-9687-4e90-935a-ba6778829c86

---

## Statistics

- **Lines Added:** +653
- **Lines Removed:** -54
- **Files Changed:** 10
- **Net Change:** 599

## Files Modified
- .spec-workflow/specs/model-driven-crud-framework/tasks.md
- approot/app.py
- approot/repositories/generic_repo.py
- approot/services/generic_service.py
- approot/templates/components/field_types/email.html
- approot/templates/components/field_types/text.html
- approot/templates/components/field_types/textarea.html
- approot/templates/components/form.html
- tests/test_app_routes.py

## Files Created
- tests/test_save_endpoint.py

---

## Artifacts

### API Endpoints

#### POST /<entity_name>/save
- **Purpose:** 受け取ったフォームデータを検証し、サービス経由で保存して部分テンプレートを返す。未知エンティティ/レコードは 404、バリデーションエラーは 400、サーバーエラーは 500 を返す。
- **Location:** approot/app.py#L146-L171
- **Request Format:** Form fields per entity definition (including primary key for updates)
- **Response Format:** 200: entity partial (view mode) | 400: entity partial with errors | 404/500: plain text error

### Components

#### form.html + field_types
- **Type:** Jinja (Flask)
- **Purpose:** エンティティフォームをセクション/フィールドで描画し、各フィールドのバリデーションエラーを表示。
- **Location:** approot/templates/components/form.html
- **Props:** context expects entity, record, mode, errors, action_url, target
- **Exports:** form.html, field_types/text.html, field_types/email.html, field_types/textarea.html

### Functions

#### save
- **Purpose:** エンティティ定義に基づきレコードを insert/update し、更新後のレコードを返す。
- **Location:** approot/repositories/generic_repo.py#L123-L190
- **Signature:** (entity: Dict[str, Any], payload: Dict[str, Any]) -> Dict[str, Any]
- **Exported:** Yes

#### _validate_field
- **Purpose:** 必須/メール形式の簡易バリデーションを行い、エラーメッセージを返す。
- **Location:** approot/services/generic_service.py#L212-L234
- **Signature:** (field: Dict[str, Any], value: Any) -> str | None
- **Exported:** No

#### handle_save
- **Purpose:** 入力をバリデートし、リポジトリ保存を呼び出してコンテキストを返す。バリデーション失敗時は errors を含めて 400 を返す。
- **Location:** approot/services/generic_service.py#L237-L317
- **Signature:** (entities: Dict[str, Dict[str, Any]], entity_name: str, payload: Dict[str, Any]) -> Dict[str, Any]
- **Exported:** Yes

### Integrations

#### Integration
- **Description:** entity_save ルートが handle_save へ委譲し、バリデーションを通過したデータを generic_repo.save で永続化。結果コンテキストを entity.html 部分テンプレートで返却し、HTMX 部分更新に対応。
- **Frontend Component:** templates/partials/entity.html + form components
- **Backend Endpoint:** POST /<entity_name>/save
- **Data Flow:** フォーム送信 → entity_save → handle_save (validate) → generic_repo.save (insert/update) → ctx → entity.html render → HTMX target update

