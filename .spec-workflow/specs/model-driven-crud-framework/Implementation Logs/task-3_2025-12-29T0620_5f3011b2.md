# Implementation Log: Task 3

**Summary:** 汎用サービス層を追加し、list/detail/form 文脈生成とアクションディスパッチを TDD で実装。例外時のエラーフォールバックと未定義エンティティ/レコード対応を含むテストを作成。

**Timestamp:** 2025-12-29T06:20:05.805Z
**Log ID:** 5f3011b2-467f-4341-8e79-4c5b6ec1bdd6

---

## Statistics

- **Lines Added:** +446
- **Lines Removed:** -1
- **Files Changed:** 3
- **Net Change:** 445

## Files Modified
- .spec-workflow/specs/model-driven-crud-framework/tasks.md

## Files Created
- approot/services/generic_service.py
- tests/test_generic_service.py

---

## Artifacts

### Functions

#### render_list
- **Purpose:** エンティティ定義に基づいて一覧表示用コンテキストを組み立て、ページング・ソート情報と actions を含める
- **Location:** approot/services/generic_service.py:54
- **Signature:** (entities: Dict[str, Dict[str, Any]], entity_name: str, page: int = 1, page_size: int | None = None, sort: str | None = None) -> Dict[str, Any]
- **Exported:** Yes

#### render_detail
- **Purpose:** 単一レコード取得と view モード向けコンテキスト生成。未発見時は 404 コンテキストを返す
- **Location:** approot/services/generic_service.py:87
- **Signature:** (entities: Dict[str, Dict[str, Any]], entity_name: str, pk: Any) -> Dict[str, Any]
- **Exported:** Yes

#### render_form
- **Purpose:** create/edit モードのフォームコンテキストを生成し、既存レコード取得やエラーを扱う
- **Location:** approot/services/generic_service.py:122
- **Signature:** (entities: Dict[str, Dict[str, Any]], entity_name: str, pk: Any | None = None) -> Dict[str, Any]
- **Exported:** Yes

#### handle_action
- **Purpose:** エンティティに紐づくカスタムアクションを検出し、ハンドラにディスパッチして結果コンテキストを返す
- **Location:** approot/services/generic_service.py:163
- **Signature:** (entities: Dict[str, Dict[str, Any]], entity_name: str, action_name: str, payload: Dict[str, Any] | None = None, handlers: Mapping[str, Callable[[Dict[str, Any], Dict[str, Any]], Any]] | None = None) -> Dict[str, Any]
- **Exported:** Yes

#### _missing_entity
- **Purpose:** 未定義エンティティアクセス時の共通エラーレスポンスを生成
- **Location:** approot/services/generic_service.py:19
- **Signature:** (entity_name: str, mode: str) -> Dict[str, Any]
- **Exported:** No

#### _find_action
- **Purpose:** エンティティの form/list アクション定義から対象アクションを検索
- **Location:** approot/services/generic_service.py:44
- **Signature:** (entity: Dict[str, Any], action_name: str) -> Dict[str, Any] | None
- **Exported:** No

### Integrations

#### Integration
- **Description:** generic_service が entities_loader.get_entity で定義を解決し、generic_repo.fetch_list/fetch_detail を呼んでコンテキスト辞書を構築する
- **Frontend Component:** null
- **Backend Endpoint:** generic_repo.fetch_list, fetch_detail
- **Data Flow:** Service resolves entity -> calls generic_repo for data -> shapes context with mode/actions -> templates/HTMX で利用できる辞書を返却

