# Implementation Log: Task 5 - Flask Generic Routes

**Task ID:** task-5  
**Date:** 2025-12-29T06:50  
**Status:** ✅ Completed  
**Approach:** TDD (Test-Driven Development)

## Summary

TDD で Flask 汎用ルートを実装し、エンティティベースの CRUD エンドポイントを追加しました。既存の固定ルート (`/`, `/list`, `/detail/<id>`) を維持しつつ、`/<entity>/list`, `/<entity>/detail/<id>`, `/<entity>/form[/<id>]`, `/<entity>/save`, `/<entity>/actions/<action>`, `/lookup/<lookup_name>` の7つの汎用ルートを追加。全63テスト（新規21 + 既存42）がパスし、generic_service を経由して HTMX 部分テンプレートを正しく返却することを確認しました。

## Artifacts

### 1. API Endpoints (Flask Routes)

#### File: `approot/app.py`

**Changes:**
- **Import追加:** `request` (Flask), `entities_loader`, `generic_service`, `Path`
- **起動時処理:** `entities.yaml` を一度だけロードし、`_ENTITIES` 辞書に保持
- **7つの汎用ルート:**

1. **`GET /<entity_name>/list`** (`entity_list`)
   - クエリパラメータ: `page`, `page_size`, `sort`
   - `generic_service.render_list()` を呼び出し
   - 成功時: `partials/list.html` を描画
   - エラー時: ステータスコードとエラーメッセージを返却

2. **`GET /<entity_name>/detail/<int:pk>`** (`entity_detail`)
   - `generic_service.render_detail()` を呼び出し (mode="view")
   - 成功時: `partials/entity.html` を描画
   - エラー時: 404 または 500

3. **`GET /<entity_name>/form`** (`entity_form`, pk=None)
   - `generic_service.render_form()` を呼び出し (mode="create")
   - 成功時: `partials/entity.html` を描画

4. **`GET /<entity_name>/form/<int:pk>`** (`entity_form`, pk 指定)
   - `generic_service.render_form()` を呼び出し (mode="edit")
   - 成功時: `partials/entity.html` を描画
   - レコード未存在時: 404

5. **`POST /<entity_name>/save`** (`entity_save`)
   - エンティティ存在確認 → 404
   - 現時点: 501 Not Implemented (placeholder)
   - 将来: `repository.save()` 実装後に完成

6. **`POST /<entity_name>/actions/<action_name>`** (`entity_action`)
   - `generic_service.handle_action()` を呼び出し
   - ハンドラ未登録時: 501
   - 成功時: アクション実行メッセージを返却

7. **`GET /lookup/<lookup_name>`** (`lookup_search`)
   - クエリパラメータ: `q` (検索クエリ), `limit`
   - エンティティ存在確認 → `generic_repo.search_lookup()` 呼び出し
   - 成功時: `components/lookup.html` を描画
   - エンティティ未存在時: 空の結果を返却

**エラーハンドリング:**
- 未知のエンティティ → 404
- レコード未存在 → 404
- 未実装機能 → 501
- サーバーエラー → 500
- すべてのエラーを `app.logger` でログ記録

**既存ルート維持:**
- `/` → `layout.html`
- `/list` → 既存の顧客一覧 (db.get_customers)
- `/detail/<int:customer_id>` → 既存の顧客詳細 (db.get_customer_detail)

### 2. Tests

#### File: `tests/test_app_routes.py` (新規作成)

**21のテストケース:**

**List Endpoint (4 tests):**
- `test_entity_list_route` - 基本的な一覧取得
- `test_entity_list_route_with_pagination` - ページネーション
- `test_entity_list_route_with_sort` - ソート
- `test_entity_list_route_unknown_entity` - 未知のエンティティで404

**Detail Endpoint (3 tests):**
- `test_entity_detail_route` - 詳細表示 (view mode)
- `test_entity_detail_route_not_found` - 未存在レコードで404
- `test_entity_detail_route_unknown_entity` - 未知のエンティティで404

**Form Endpoint (4 tests):**
- `test_entity_form_create_route` - 新規作成フォーム (mode=create)
- `test_entity_form_edit_route` - 編集フォーム (mode=edit)
- `test_entity_form_edit_route_not_found` - 未存在レコードで404
- `test_entity_form_route_unknown_entity` - 未知のエンティティで404

**Save Endpoint (2 tests):**
- `test_entity_save_route` - 保存処理 (501 placeholder)
- `test_entity_save_route_unknown_entity` - 未知のエンティティで404

**Action Endpoint (3 tests):**
- `test_entity_action_route` - アクション実行
- `test_entity_action_route_unknown_entity` - 未知のエンティティで404
- `test_entity_action_route_unknown_action` - 未知のアクションで404

**Lookup Endpoint (2 tests):**
- `test_lookup_route` - Lookup検索
- `test_lookup_route_with_query` - クエリパラメータ付き検索

**Backward Compatibility (3 tests):**
- `test_existing_index_route_still_works` - 既存 `/` ルート
- `test_existing_list_route_still_works` - 既存 `/list` ルート
- `test_existing_detail_route_still_works` - 既存 `/detail/<id>` ルート

**Mock Strategy:**
- `stub_requests_and_env`: Databricks 依存をスタブ化
- `mock_db`: db モジュールをモック
- `mock_entities_loader`: テスト用エンティティ定義を返却
- `mock_generic_repo`: `fetch_list`, `fetch_detail`, `search_lookup` をモック

### 3. Documentation

#### File: `.spec-workflow/specs/model-driven-crud-framework/tasks.md`

**Update:**
```markdown
- [x] 5. Flask ルートを TDD で汎用化して配線する
```

## Test Results

```bash
$ python -m pytest tests/ -v
======================== 63 passed in 0.45s =======================
```

**新規テスト:** 21 passed  
**既存テスト:** 42 passed (test_entities_loader, test_generic_repo, test_generic_service, test_htmx_endpoints)

## Key Design Decisions

1. **TDD アプローチ:**
   - テストを先に書いてから実装 (Red → Green → Refactor)
   - 全ルートに対して happy path, error path, edge case を網羅

2. **エンティティ読み込み:**
   - 起動時に一度だけ `entities.yaml` をロードし、グローバル変数 `_ENTITIES` に保持
   - リクエストごとに再読み込みしないことでパフォーマンスを最適化

3. **エラー処理の一貫性:**
   - `generic_service` が返す `ctx['ok']` と `ctx['status']` を確認
   - エラー時はログを記録し、簡潔なメッセージを返却
   - HTMX クライアントが部分テンプレートまたはエラーメッセージを受け取る

4. **既存コードの保護:**
   - 既存の固定ルート (`/`, `/list`, `/detail/<id>`) を削除・変更せず維持
   - 汎用ルートは `/<entity>/` プレフィックスで区別

5. **Save の段階的実装:**
   - `/<entity>/save` は 501 を返すプレースホルダー
   - `repository.save()` が実装されたら完成させる予定

6. **Lookup の簡略化:**
   - lookup_name をエンティティ名として解決
   - 将来的には lookup 設定マッピングを追加する可能性

## Integration Points

- **generic_service:** `render_list`, `render_detail`, `render_form`, `handle_action`
- **generic_repo:** `search_lookup` (lookup エンドポイント)
- **entities_loader:** `load_entities` (起動時)
- **Templates:**
  - `partials/list.html` (一覧)
  - `partials/entity.html` (詳細・フォーム、mode で切替)
  - `components/lookup.html` (Lookup モーダル)

## Future Work

1. **Save 実装:** `repository.save()` を追加し、`/<entity>/save` を完成
2. **Lookup マッピング:** `entities.yaml` に lookup 定義を追加し、lookup_name → entity の解決を改善
3. **Action ハンドラ登録:** カスタムアクションのハンドラを登録する仕組み
4. **バリデーション:** フォーム送信時のバリデーション追加
5. **リダイレクト:** Save/Action 成功後にリスト画面へリダイレクト

## Lessons Learned

- **TDD の効果:** テスト先行により、エッジケースとエラーパスを早期に発見できた
- **Mock の重要性:** Flask test client + monkeypatch で外部依存を排除し、高速なテストを実現
- **既存コードとの共存:** 汎用ルートと固定ルートを並存させることで、段階的な移行が可能

## Commit

```
commit b4bc5ab
Author: GitHub Copilot
Date:   2025-12-29

    Implement Task 5: Flask generic routes with TDD (all tests passing)
    
    - Added 7 generic entity routes (list/detail/form/save/actions/lookup)
    - Created 21 new tests in test_app_routes.py
    - Load entities.yaml once at startup
    - Existing routes maintained for backward compatibility
    - All 63 tests passing
```
